{% extends 'base.html.twig' %}

{% block title %}Paiement{% endblock %}

{% block body %}
<div class="row">


<div class="col-8">
<h4 class="text-uppercase">Bonjour: {{user.lastname}} {{user.firstname}}</h4>
 


    
<a href="/address/new" class="btn btn-blue btn-lg">Ajouter une adresse</a>
 
<!--liste des prodduit-->


<table class="table table-bordered">

 <h5>Récapitulatif de la commande:</h5>
  
  
  
  <thead>
    <tr>
    <td>Nom du produit:</td>
    <td>Prix</td>
    <td>Quantité du produit:</td>
    
    </tr>
    </thead>    
    
    <thbody>
    {% for cartWithData in cartWithData %}  
      <tr>
        <td>
        {{ cartWithData.product.name }} - {{ cartWithData.state.state }}
        </td>
        <td>
        {{ cartWithData.state.price }}€
        </td>
        <td>
        {{ cartWithData.quantity }}
        </td>
      </tr>
      {% endfor %}
      <th>
        Prix total TTC:
      </th>
      <th colspan="2">
        {{ total }}€
      </th>
      </thbody>  
</table>
</div>


<div class="col-4" id="payement_form">
<h4>Paiement:</h4>

    {{ form_start(form, {attr: {id: form.vars.id}}) }}
    <div class="form-group">
    {{ form_row(form.shippingAddress) }} 
    </div>
    <div class="form-group">
    {{ form_row(form.billingAddress) }}
    </div> 
    <div class="form-group">
      <label for="card-element">
        Credit or Debit Card
      </label>
      <div id="card-element" class="form-control"></div>
      <div id="card-errors" class="help-block" role="alert"></div>
    </div>
    {{ form_widget(form.paymentToken) }}
    <button type="submit">Payer</button>
    {{ form_end(form) }}
</div>

</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
   var form = document.getElementById('{{ form.vars.id }}');
        var errors = document.getElementById('card-errors');

        var stripe = Stripe('{{ stripe_public_key }}');
        var elements = stripe.elements();
        var card = elements.create('card');

        card.mount('#card-element');
        card.addEventListener('change', function(event) {
          if (event.error) {
            errors.textContent = event.error.message;
            form.classList.add('has-error');
          } else {
            errors.textContent = '';
            form.classList.remove('has-error');
          }
        });

        form.addEventListener('submit', function(event) {
          event.preventDefault();

          stripe.createToken(card).then(function(result) {
            if (result.error) {
              errors.textContent = result.error.message;
              form.classList.add('has-error');
            } else {
              document.getElementById('{{ form.children.paymentToken.vars.id }}').setAttribute('value', result.token.id);
              form.submit();
            }
          });
        });
</script>
{% endblock %}

